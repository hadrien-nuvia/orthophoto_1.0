name: Build Orthophoto App (NuGet Binary Cache)

on:
  workflow_dispatch:

# Cancel in-progress runs of the same workflow for the same branch/PR
# This allows force-stopping by triggering a new run or pushing new commits
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: write
  packages: write

env:
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg
  VCPKG_DEFAULT_TRIPLET: x64-windows
  # Configuration NuGet pour cache binaire vcpkg
  VCPKG_BINARY_SOURCES: "clear;nuget,https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json,readwrite"

jobs:
  verify-nuget-packages-exist:
    runs-on: windows-latest
    outputs:
      packages-found: ${{ steps.check-packages.outputs.packages-found }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for required NuGet packages in GitHub Packages
        id: check-packages
        shell: pwsh
        run: |
          Write-Host "Checking GitHub Packages for required vcpkg binaries..." -ForegroundColor Cyan
          Write-Host ""

          # List of key packages we require
          $keyPackages = @("vtk", "pcl", "pdal", "gdal", "proj", "geos", "zlib", "qtbase")

          Write-Host "Looking for the following key packages:" -ForegroundColor Yellow
          $keyPackages | ForEach-Object { Write-Host "  - $_" }
          Write-Host ""

          # Use GitHub API to fetch packages
          Write-Host "Fetching package list from GitHub Packages API..." -ForegroundColor Cyan
          
          $headers = @{
            'Authorization' = 'Bearer ${{ secrets.GITHUB_TOKEN }}'
            'Accept' = 'application/vnd.github+json'
            'X-GitHub-Api-Version' = '2022-11-28'
          }

          $owner = "${{ github.repository_owner }}"
          $triplet = "${{ env.VCPKG_DEFAULT_TRIPLET }}"
          
          # Detect if owner is an organization or user account
          Write-Host "Detecting owner type..." -ForegroundColor Cyan
          $ownerInfoUrl = "https://api.github.com/users/$owner"
          $ownerInfo = Invoke-RestMethod -Uri $ownerInfoUrl -Headers $headers -Method Get
          
          $isOrg = $ownerInfo.type -eq "Organization"
          $ownerType = if ($isOrg) { "orgs" } else { "users" }
          
          Write-Host "Owner '$owner' is a $($ownerInfo.type)" -ForegroundColor Gray
          Write-Host ""
          
          # Fetch all NuGet packages from the owner (organization or user)
          $allPackages = @()
          $page = 1
          $perPage = 100
          
          do {
            $apiUrl = "https://api.github.com/$ownerType/$owner/packages?package_type=nuget&per_page=$perPage&page=$page"
            
            try {
              $response = Invoke-RestMethod -Uri $apiUrl -Headers $headers -Method Get
              
              if ($response -and $response.Count -gt 0) {
                $allPackages += $response
                Write-Host "  Fetched page $page`: $($response.Count) packages" -ForegroundColor Gray
                $page++
              } else {
                break
              }
            } catch {
              Write-Host "  Error fetching page $page`: $_" -ForegroundColor Yellow
              break
            }
          } while ($response.Count -eq $perPage)
          
          Write-Host ""
          Write-Host "Total packages found: $($allPackages.Count)" -ForegroundColor Cyan
          
          # Debug: Show first few packages found
          Write-Host "Sample of packages found (first 10):" -ForegroundColor Gray
          $allPackages | Select-Object -First 10 | ForEach-Object { 
            Write-Host "  $($_.name)" -ForegroundColor Gray 
          }
          Write-Host ""
          
          $foundPackages = @()
          $missingPackages = @()

          foreach ($pkg in $keyPackages) {
            # vcpkg NuGet packages use the format: {portname}_{triplet}
            $searchPattern = "^${pkg}[._-]${triplet}"
            
            # Check if any package matches the pattern
            $matchedPackages = $allPackages | Where-Object { $_.name -match $searchPattern }

            if ($matchedPackages -and $matchedPackages.Count -gt 0) {
              $foundPackages += $pkg
              Write-Host "✓ Found: $pkg ($($matchedPackages.Count) package(s))" -ForegroundColor Green
              $matchedPackages | Select-Object -First 3 | ForEach-Object {
                Write-Host "    - $($_.name)" -ForegroundColor Gray
              }
            } else {
              $missingPackages += $pkg
              Write-Host "✗ Not found: $pkg" -ForegroundColor Red
            }
          }

          Write-Host ""
          Write-Host "=== Summary ===" -ForegroundColor Cyan
          Write-Host "Packages found: $($foundPackages.Count)/$($keyPackages.Count)" -ForegroundColor $(if ($foundPackages.Count -eq $keyPackages.Count) { "Green" } else { "Yellow" })

          if ($foundPackages.Count -gt 0) {
            Write-Host ""
            Write-Host "Found packages:" -ForegroundColor Green
            $foundPackages | ForEach-Object { Write-Host "  ✓ $_" -ForegroundColor Green }
          }

          if ($missingPackages.Count -gt 0) {
            Write-Host ""
            Write-Host "Missing packages:" -ForegroundColor Yellow
            $missingPackages | ForEach-Object { Write-Host "  ✗ $_" -ForegroundColor Yellow }
          }

          # Set output variable for downstream jobs
          $allPackagesFound = $foundPackages.Count -eq $keyPackages.Count
          echo "packages-found=$allPackagesFound" >> $env:GITHUB_OUTPUT
          Write-Host ""
          Write-Host "packages-found output set to: $allPackagesFound"

  verify-cache-exists:
    runs-on: windows-latest
    needs: verify-nuget-packages-exist
    if: needs.verify-nuget-packages-exist.outputs.packages-found != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Fail with message if NuGet packages missing
        shell: pwsh
        run: |
          Write-Host "❌ ERREUR: Packages vcpkg NuGet requis non trouvés!" -ForegroundColor Red
          Write-Host ""
          Write-Host "═══════════════════════════════════════════════════════════" -ForegroundColor Yellow
          Write-Host "  Le cache binaire NuGet est REQUIS pour ce workflow" -ForegroundColor Yellow
          Write-Host "═══════════════════════════════════════════════════════════" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "Pour créer le cache, suivez ces étapes:" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "  1. Allez dans l'onglet 'Actions' de ce dépôt"
          Write-Host "  2. Sélectionnez le workflow:"
          Write-Host "     'Build vcpkg binary cache with NuGet (grouped)'"
          Write-Host "  3. Cliquez sur 'Run workflow'"
          Write-Host "  4. Attendez la fin de la construction du cache (~3-4 heures)"
          Write-Host "  5. Relancez ce workflow"
          Write-Host ""
          Write-Host "Pour plus d'informations, consultez NUGET_CACHE_GUIDE.md" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "═══════════════════════════════════════════════════════════" -ForegroundColor Red
          Write-Host "  L'installation s'arrête ici" -ForegroundColor Red
          Write-Host "═══════════════════════════════════════════════════════════" -ForegroundColor Red
          exit 1

  build:
    runs-on: windows-latest
    needs: [verify-nuget-packages-exist, verify-cache-exists]
    if: always() && needs.verify-nuget-packages-exist.outputs.packages-found == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup NuGet
        shell: pwsh
        run: |
          Write-Host "Installing NuGet CLI..." -ForegroundColor Cyan
          
          # Install NuGet CLI if not present
          if (-not (Get-Command nuget -ErrorAction SilentlyContinue)) {
            Invoke-WebRequest -Uri https://dist.nuget.org/win-x86-commandline/latest/nuget.exe -OutFile nuget.exe
            $nugetPath = Join-Path $PWD "nuget.exe"
            $env:PATH = "$PWD;$env:PATH"
            [System.Environment]::SetEnvironmentVariable('PATH', $env:PATH, 'Process')
          }
          
          Write-Host "NuGet version:" -ForegroundColor Green
          nuget help | Select-Object -First 3
          Write-Host "✓ NuGet CLI ready" -ForegroundColor Green

      - name: Cache Qt installation
        id: qt-cache
        uses: actions/cache@v3
        with:
          path: ${{ github.workspace }}/Qt
          key: Qt-${{ runner.os }}-6.5.3
          restore-keys: |
            Qt-${{ runner.os }}-
      
      - name: Set up Python 3.11
        if: steps.qt-cache.outputs.cache-hit != 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install aqtinstall
        if: steps.qt-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install aqtinstall

      - name: Install Qt 6.5.3 (qtwidgets module)
        if: steps.qt-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          python -m aqt install-qt windows desktop 6.5.3 win64_msvc2019_64 --outputdir ${{ github.workspace }}/Qt
        continue-on-error: true

      - name: Clone and bootstrap vcpkg
        shell: pwsh
        run: |
          # Retry logic for cloning vcpkg (handles rate limiting)
          $maxAttempts = 3
          $attempt = 0
          $success = $false
          
          while (-not $success -and $attempt -lt $maxAttempts) {
            $attempt++
            Write-Host "Tentative $attempt de clonage de vcpkg..."
            
            try {
              # Use shallow clone to save time and bandwidth
              git clone --depth 1 https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
              $success = $true
              Write-Host "Clonage réussi!"
            } catch {
              Write-Host "Échec de la tentative $attempt"
              if ($attempt -lt $maxAttempts) {
                Write-Host "Nouvelle tentative dans 10 secondes..."
                Start-Sleep -Seconds 10
              } else {
                throw "Impossible de cloner vcpkg après $maxAttempts tentatives"
              }
            }
          }
          
          Push-Location $env:VCPKG_ROOT
          .\bootstrap-vcpkg.bat
          Pop-Location

      - name: Restore vcpkg caches (downloads et installed uniquement)
        id: vcpkg-cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.VCPKG_ROOT }}/downloads
            ${{ env.VCPKG_ROOT }}/installed
          key: vcpkg-${{ runner.os }}-nuget-heavy-3-pdal-${{ hashFiles('**/vcpkg.json') }}
          restore-keys: |
            vcpkg-${{ runner.os }}-nuget-heavy-3-pdal-
            vcpkg-${{ runner.os }}-nuget-heavy-2-pcl-${{ hashFiles('**/vcpkg.json') }}
            vcpkg-${{ runner.os }}-nuget-heavy-2-pcl-
            vcpkg-${{ runner.os }}-nuget-heavy-1-vtk-${{ hashFiles('**/vcpkg.json') }}
            vcpkg-${{ runner.os }}-nuget-heavy-1-vtk-
            vcpkg-${{ runner.os }}-nuget-geo-${{ hashFiles('**/vcpkg.json') }}
            vcpkg-${{ runner.os }}-nuget-geo-
            vcpkg-${{ runner.os }}-nuget-core-${{ hashFiles('**/vcpkg.json') }}
            vcpkg-${{ runner.os }}-nuget-

      - name: Configure NuGet authentication
        shell: pwsh
        run: |
          # Configuration de l'authentification NuGet pour vcpkg
          $nugetConfig = @"
          <?xml version="1.0" encoding="utf-8"?>
          <configuration>
            <packageSources>
              <add key="github" value="https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" />
            </packageSources>
            <packageSourceCredentials>
              <github>
                <add key="Username" value="${{ github.repository_owner }}" />
                <add key="ClearTextPassword" value="${{ secrets.GITHUB_TOKEN }}" />
              </github>
            </packageSourceCredentials>
          </configuration>
          "@
          
          # Créer le dossier NuGet config s'il n'existe pas
          $nugetConfigPath = "$env:APPDATA\NuGet"
          if (-not (Test-Path $nugetConfigPath)) {
            New-Item -ItemType Directory -Path $nugetConfigPath -Force | Out-Null
          }
          
          # Écrire le fichier de configuration
          $nugetConfig | Out-File -FilePath "$nugetConfigPath\NuGet.Config" -Encoding utf8
          Write-Host "✓ NuGet configuration created successfully" -ForegroundColor Green
          
          # Also configure mono for vcpkg NuGet integration (required for vcpkg to use NuGet)
          $monoNugetConfigPath = "$env:APPDATA\..\Local\NuGet"
          if (-not (Test-Path $monoNugetConfigPath)) {
            New-Item -ItemType Directory -Path $monoNugetConfigPath -Force | Out-Null
          }
          $nugetConfig | Out-File -FilePath "$monoNugetConfigPath\NuGet.Config" -Encoding utf8

      - name: Configure vcpkg for NuGet binary caching
        shell: pwsh
        run: |
          # Installer mono pour vcpkg (requis pour NuGet sur Windows)
          Write-Host "Configuration du cache binaire NuGet vcpkg..." -ForegroundColor Cyan
          
          # Définir les variables d'environnement pour vcpkg
          [System.Environment]::SetEnvironmentVariable('VCPKG_BINARY_SOURCES', $env:VCPKG_BINARY_SOURCES, 'Process')
          
          Write-Host "VCPKG_BINARY_SOURCES = $env:VCPKG_BINARY_SOURCES"
          
          # Fetch vcpkg's NuGet executable and configure the source
          $vcpkgNuget = & "$env:VCPKG_ROOT\vcpkg" fetch nuget
          Write-Host "vcpkg NuGet path: $vcpkgNuget"
          
          # Add the GitHub Packages source using vcpkg's nuget (suppress errors if already exists)
          & $vcpkgNuget sources add -Name "github" -Source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" -Username "${{ github.repository_owner }}" -Password "${{ secrets.GITHUB_TOKEN }}" -StorePasswordInClearText 2>&1 | Out-Null
          
          # Set API key for reading packages from the cache
          & $vcpkgNuget setapikey "${{ secrets.GITHUB_TOKEN }}" -Source "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json" 2>&1 | Out-Null
          
          Write-Host "✓ vcpkg NuGet binary cache configured successfully" -ForegroundColor Green

      - name: Show cache hit info
        shell: pwsh
        run: |
          Write-Host "vcpkg cache hit: ${{ steps.vcpkg-cache.outputs.cache-hit }}"
          Write-Host "Configuration NuGet Binary Cache active"

      - name: List vcpkg cache folders (diagnostic)
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Write-Host "VCPKG_ROOT = $env:VCPKG_ROOT"
          if (Test-Path $env:VCPKG_ROOT) {
            Get-ChildItem -Force $env:VCPKG_ROOT | Select-Object Name, LastWriteTime, Mode
          } else {
            Write-Host "No vcpkg root found."
          }

      - name: vcpkg version & help (diagnostic)
        if: steps.vcpkg-cache.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          & "$env:VCPKG_ROOT\vcpkg" version
          Write-Host "`nConfiguration du cache binaire:"
          & "$env:VCPKG_ROOT\vcpkg" help binarycaching

      - name: Install dependencies with vcpkg (manifest mode + NuGet cache)
        shell: pwsh
        run: |
          $triplet = "${{ env.VCPKG_DEFAULT_TRIPLET }}"
          Write-Host "Installation des dépendances avec cache binaire NuGet..."
          Write-Host "VCPKG_BINARY_SOURCES = $env:VCPKG_BINARY_SOURCES"
          
          & "$env:VCPKG_ROOT\vcpkg" install --triplet $triplet --clean-packages-after-build

      - name: Configure CMake (using vcpkg toolchain)
        shell: pwsh
        env:
          VCPKG_DEFAULT_TRIPLET: ${{ env.VCPKG_DEFAULT_TRIPLET }}
        run: |
          $triplet = "${{ env.VCPKG_DEFAULT_TRIPLET }}"
          $toolchain = "${{ env.VCPKG_ROOT }}\scripts\buildsystems\vcpkg.cmake"
          $qtPath = "${{ github.workspace }}\Qt\6.5.3\msvc2019_64"
          
          Write-Host "Configuring CMake..."
          Write-Host "Triplet: $triplet"
          Write-Host "Toolchain: $toolchain"
          Write-Host "VCPKG_DEFAULT_TRIPLET env: $env:VCPKG_DEFAULT_TRIPLET"
          
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_TOOLCHAIN_FILE="$toolchain" `
            -DVCPKG_TARGET_TRIPLET="$triplet" `
            -DCMAKE_PREFIX_PATH="$qtPath"

      - name: Build with CMake (Release)
        shell: pwsh
        run: |
          cmake --build build --config Release -- -m

      - name: Upload executable artifact
        uses: actions/upload-artifact@v4
        with:
          name: orthophoto_gui-nuget-${{ runner.os }}
          path: build/Release/orthophoto_gui.exe
          if-no-files-found: warn

      - name: Build status summary
        if: always()
        shell: pwsh
        env:
          JOB_STATUS: ${{ job.status }}
          VCPKG_CACHE_HIT: ${{ steps.vcpkg-cache.outputs.cache-hit }}
          QT_CACHE_HIT: ${{ steps.qt-cache.outputs.cache-hit }}
        run: |
          Write-Host "=== Build Summary (NuGet Binary Cache) ==="
          Write-Host "Job Status: $env:JOB_STATUS"
          Write-Host "vcpkg Cache Hit: $env:VCPKG_CACHE_HIT"
          Write-Host "Qt Cache Hit: $env:QT_CACHE_HIT"
          Write-Host "NuGet Binary Cache: ENABLED"
          Write-Host "VCPKG_BINARY_SOURCES: $env:VCPKG_BINARY_SOURCES"
